<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">1st Time Parties</h5>
      <a class="ms-2" href={% url 'report-view' result.all_parties_with_sale.report.id %} target="_blank">View/Update<i class="fas fa-fw fa-external-link-alt"></i></a>
      <!-- <div class="d-flex justify-content-end align-items-center">
          <div class="me-1">
              {% comment %} {% include 'commonutil/time_interval_select.html' %} {% endcomment %}
          </div>
      </div> -->
  </div>
  <div class="card-body">
      <div class="chart w-100">
          <canvas id="chartjs-bar"></canvas>
      </div>
  </div>
</div>

<script>
  const apiUrlAllParties = '{% url 'report-datefilter-data-api' result.all_parties_with_sale.report.id|default:"0" %}';
  
  function fetchChartData() {
    $.ajax({
      url: apiUrlAllParties,
      type: 'GET',
      dataType: 'json',
      success: function (response) {
        if (response && response.data && response.data.all_parties_with_sale) {
          const chartData = processData(response.data.all_parties_with_sale);
          populateBarChart(chartData);
        } else {
          $('#chartjs-bar').replaceWith('<div class="alert alert-warning">No data available.</div>');
        }
      },
      error: function (xhr, status, error) {
        $('#chartjs-bar').replaceWith('<div class="alert alert-danger">Error fetching data.</div>');
      }
    });
  }

  function processData(data) {
    const currentYear = new Date().getFullYear();
    const lastYear = currentYear - 1;
    const monthlyData = { current: Array(12).fill(0), last: Array(12).fill(0) };

    data.forEach(item => {
      const saleDate = new Date(item.first_sale);
      const saleYear = saleDate.getFullYear();
      const saleMonth = saleDate.getMonth(); // 0-based month

      if (saleYear === currentYear) {
        monthlyData.current[saleMonth]++;
      } else if (saleYear === lastYear) {
        monthlyData.last[saleMonth]++;
      }
    });

    return monthlyData;
  }

  function populateBarChart(chartData) {
    new Chart($("#chartjs-bar"), {
      type: "bar",
      data: {
        labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        datasets: [{
          label: "This year",
          backgroundColor: window.theme.primary,
          borderColor: window.theme.primary,
          hoverBackgroundColor: window.theme.primary,
          hoverBorderColor: window.theme.primary,
          data: chartData.current,
          barPercentage: .75,
          categoryPercentage: .5
        }, {
          label: "Last year",
          backgroundColor: "#dee2e6",
          borderColor: "#dee2e6",
          hoverBackgroundColor: "#dee2e6",
          hoverBorderColor: "#dee2e6",
          data: chartData.last,
          barPercentage: .75,
          categoryPercentage: .5
        }]
      },
      options: {
        maintainAspectRatio: false,
        legend: {
          display: true,
          position: 'top',
          align: 'end'
        },
        scales: {
          yAxes: [{
            gridLines: {
              display: false
            },
            stacked: false,
            ticks: {
              stepSize: 20
            }
          }],
          xAxes: [{
            stacked: false,
            gridLines: {
              color: "transparent"
            }
          }]
        }
      }
    });
  }

  $(document).ready(function() {
    fetchChartData();
  });
</script>
