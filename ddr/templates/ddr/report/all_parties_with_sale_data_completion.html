<div class="card">
  <div class="card-header">
    <h5 class="card-title">All Parties data completion</h5>
  </div>
  
  <div style="overflow-x: auto; margin: 0; padding: 0;">
    <table id="report-table" class="table table-bordered table-sm" style="margin: 0;">
      <tr>
          {% for column, count in result.all_parties_with_sale.counts.items %}
            <th class="report-column" style="white-space: nowrap; padding-left: 1rem; padding-right: 1rem;" data-column="{{ column }}">{{ column }}</th>
          {% endfor %}
        </tr>
        <tr>
          {% for column, count in result.all_parties_with_sale.counts.items %}
            <td data-column="{{ column }}" style="padding-left: 1rem;" class="report-column {% if count > result.all_parties_with_sale.threshold.danger %} bg-danger text-light
              {% elif count >= result.all_parties_with_sale.threshold.action and count <= result.all_parties_with_sale.threshold.danger %} bg-warning text-dark
              {% else %} bg-success text-light
              {% endif %}" onclick="filterDataSale1('{{ column }}', '{{ count }}')">
              <a data-bs-toggle="modal" data-bs-target="#centeredModalPrimary" style="display: block; width: 100%; height: 100%; text-decoration: none; color: inherit;">
                {{ count }}
              </a>
            </td>
          {% endfor %}
        </tr>
    </table>
  </div>
</div>

<div class="modal fade" id="centeredModalPrimary" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitleSale1">All Parties data completion</h5> 
        <a class="ms-2" href={% url 'report-view' result.all_parties_with_sale.report.id %} target="_blank">Full report<i class="fas fa-fw fa-external-link-alt"></i></a>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body m-3">
        <div id="spreadsheet" class="handsontable"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" onclick="downloadExcel(window.reportExcelJson)">Download Excel</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    $('#centeredModalPrimary').on('shown.bs.modal', function () {
      var container = document.getElementById('spreadsheet');

      if (!window.handsontableManagerInstance) {
        window.handsontableManagerInstance = new handsontableManager('spreadsheet');
      } else {
        window.handsontableManagerInstance.initOrUpdateHandsontable(window.reportExcelJson);
      }
    });
  });

  // Function to filter data based on the clicked column
  window.allPartiesReportExcelJson = {{ result.all_parties_with_sale.data|safe }}; // Keep the original data
  window.reportExcelJson = [...window.allPartiesReportExcelJson]; // Displayed data

  function filterDataSale1(columnName, count) {
    if (count > 0) {
        const filteredData = window.allPartiesReportExcelJson.filter(row => row[columnName] === "" || row[columnName] === null);
        window.reportExcelJson = filteredData;
    } else {
        window.reportExcelJson = [...window.allPartiesReportExcelJson];
    }
    document.getElementById('modalTitleSale1').innerText = `All Parties: ${columnName}`;
    document.dispatchEvent(new Event('dataUpdated')); // Trigger an event to update the table
  }
</script>