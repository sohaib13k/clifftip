<div class="accordion" id="salesReportAccordion">
    {% comment %} TODO: Enable this interval change functionality  {% endcomment %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title">Sale Purchase</h5>
            <div class="d-flex justify-content-end align-items-center">
                
                <div class="form-group d-flex flex-column flex-md-row align-items-center">
                  <label for="timeInterval02" class="me-3 mb-0">Time Interval</label>
                  <select id="timeInterval02" class="form-select" style="width: auto;">
                    <option value="day">This Day</option>
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom</option>
                  </select>
                  <div class="mb-0 ms-0 ms-md-1 mt-2 mt-md-0" id="dateRangeContainer02" style="display: none;">
                    <input type="text" id="datePicker02" class="form-control flatpickr-range" placeholder="Select date or date range" style="width: auto;" />
                  </div>
                </div>

            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header" id="headingSalesPerson">
            <h2 class="mb-0">
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSalesPerson" aria-expanded="false" aria-controls="collapseSalesPerson">
                    Sales Person
                </button>
            </h2>
        </div>
        <div id="collapseSalesPerson" class="collapse" aria-labelledby="headingSalesPerson" data-bs-parent="#salesReportAccordion">
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-bordered table-sm" id="sales-table">
                        <tbody>
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header" id="headingBranchSales">
            <h2 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBranchSales" aria-expanded="false" aria-controls="collapseBranchSales">
                    Branch Sales
                </button>
            </h2>
        </div>
        <div id="collapseBranchSales" class="collapse" aria-labelledby="headingBranchSales" data-bs-parent="#salesReportAccordion">
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-bordered table-sm" id="branch-sales-table">
                        <tbody>
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header" id="headingItemTypeSales">
            <h2 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseItemTypeSales" aria-expanded="false" aria-controls="collapseItemTypeSales">
                    Item Type Sales
                </button>
            </h2>
        </div>
        <div id="collapseItemTypeSales" class="collapse" aria-labelledby="headingItemTypeSales" data-bs-parent="#salesReportAccordion">
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-bordered table-sm" id="item-type-sales-table">
                        <tbody>
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header" id="headingSalesPersonItemType">
            <h2 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSalesPersonItemType" aria-expanded="false" aria-controls="collapseSalesPersonItemType">
                    Sales Person by Item Type
                </button>
            </h2>
        </div>
        <div id="collapseSalesPersonItemType" class="collapse" aria-labelledby="headingSalesPersonItemType" data-bs-parent="#salesReportAccordion">
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-bordered table-sm" id="individual-by-item-type-sales-table">
                        <tbody>
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header" id="headingBranchItemType">
            <h2 class="mb-0">
                <button class="btn btn-link collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBranchItemType" aria-expanded="false" aria-controls="collapseBranchItemType">
                    Branch by Item Type
                </button>
            </h2>
        </div>
        <div id="collapseBranchItemType" class="collapse" aria-labelledby="headingBranchItemType" data-bs-parent="#salesReportAccordion">
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-bordered table-sm" id="branch-by-item-type-sales-table">
                        <tbody>
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const apiUrl = '{% url 'report-datefilter-data-api' result.sale_purchase.report.id|default:"0" %}';
        var requestData = {};
        var currentDate = new Date();
        var lastYearDate = new Date();
        lastYearDate.setFullYear(currentDate.getFullYear() - 1);

        function formatDate(date) {
            var day = ("0" + date.getDate()).slice(-2);
            var month = ("0" + (date.getMonth() + 1)).slice(-2);
            var year = date.getFullYear();
            return year + '-' + month + '-' + day;
        }

        requestData = {
            start_date: formatDate(lastYearDate),
            end_date: formatDate(currentDate),
        };

        

    });
</script>


<script>
    const apiUrlSalePurchase = '{% url "report-datefilter-data-api" result.sale_purchase.report.id|default:"0" %}';
  
    document.addEventListener("DOMContentLoaded", function() {  
  
      var choicesMultiple = document.querySelector(".choices-multiple");
      if (choicesMultiple) {
        new Choices(choicesMultiple);
      }
    
      // Flatpickr
      flatpickr(".flatpickr-minimum");
      flatpickr(".flatpickr-datetime", {
        enableTime: true,
        dateFormat: "d-m-Y H:i",
      });
      flatpickr(".flatpickr-human", {
        altInput: true,
        altFormat: "F j, Y",
        dateFormat: "d-m-Y",
      });
      flatpickr(".flatpickr-multiple", {
        mode: "multiple",
        dateFormat: "d-m-Y"
      });
      flatpickr(".flatpickr-range", {
        mode: "range",
        dateFormat: "d-m-Y",
        allowInput: true,
      });
      flatpickr(".flatpickr-time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
      });
      
      // Date filter AJAX
      $(document).ready(function () {
        // Function to fetch and display data based on interval
        function fetchAndDisplayData(interval, startDate = null, endDate = null) {
          var requestData = {};
  
          if (interval === 'custom') {
            requestData = {
              start_date: startDate,
              end_date: endDate
            };
            $('#dateRangeContainer02').show(); // Show date range input when custom is selected
          } else {
            $('#dateRangeContainer02').hide();
            requestData = {
              interval: interval
            };
          }
  
          function populateTable(tableId, data) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = data;
          }
          
          $.ajax({
            url: apiUrlSalePurchase,
            type: 'GET',
            data: requestData,
            dataType: 'json',
            success: function(response) {
                if (response.data) {
                    populateTable("sales-table", response.data.sales_analysis || '<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    populateTable("branch-sales-table", response.data.branch_analysis || '<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    populateTable("item-type-sales-table", response.data.item_type_analysis || '<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    populateTable("individual-by-item-type-sales-table", response.data.individual_by_item_type_analysis || '<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    populateTable("branch-by-item-type-sales-table", response.data.branch_by_item_type_analysis || '<tr><td colspan="3" class="text-center">No data available</td></tr>');
                } else {
                    $('#sales-table tbody').html('<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    $('#branch-sales-table tbody').html('<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    $('#item-type-sales-table tbody').html('<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    $('#individual-by-item-type-sales-table tbody').html('<tr><td colspan="3" class="text-center">No data available</td></tr>');
                    $('#branch-by-item-type-sales-table tbody').html('<tr><td colspan="3" class="text-center">No data available</td></tr>');
                }
            },
            error: function(xhr, status, error) {
                $('#sales-table tbody').html('<tr><td colspan="3" class="text-center text-danger">Error fetching data</td></tr>');
                $('#branch-sales-table tbody').html('<tr><td colspan="3" class="text-center text-danger">Error fetching data</td></tr>');
                $('#item-type-sales-table tbody').html('<tr><td colspan="3" class="text-center text-danger">Error fetching data</td></tr>');
                $('#individual-by-item-type-sales-table tbody').html('<tr><td colspan="3" class="text-center text-danger">Error fetching data</td></tr>');
                $('#branch-by-item-type-sales-table tbody').html('<tr><td colspan="3" class="text-center text-danger">Error fetching data</td></tr>');
            }
          });
        }
  
        function formatDate(dateString) {
          var parts = dateString.split('-');
          return parts[2] + '-' + parts[1] + '-' + parts[0];
        }
  
        function handleDateChange() {
          var dateRange = $('#datePicker02').val().split(' to ');
          if (dateRange.length === 2) {
            var startDate = formatDate(dateRange[0]);
            var endDate = formatDate(dateRange[1]);
            fetchAndDisplayData('custom', startDate, endDate);
          } else if (dateRange.length === 1) {
            var singleDate = formatDate(dateRange[0]);
            fetchAndDisplayData('custom', singleDate, singleDate);
          }
        }
  
        // Trigger fetching and displaying data when the page loads with the default selected interval
        fetchAndDisplayData($('#timeInterval02').val());
  
        // Event handler for when the select element's value changes
        $('#timeInterval02').change(function () {
          var selectedValue = $(this).val();
          if (selectedValue === 'custom') {
            $('#dateRangeContainer02').show();
            handleDateChange();
          } else {
            $('#dateRangeContainer02').hide();
            fetchAndDisplayData(selectedValue);
          }
        });
  
        // Event handler for date range change
        $('#datePicker02').change(function () {
          handleDateChange();
        });
      });
    });
  
</script>