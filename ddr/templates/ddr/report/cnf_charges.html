<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">

    <h5 class="card-title mb-0">C&F Charges</h5>
    <div class="form-group d-flex flex-column flex-md-row align-items-center">
      <label for="timeInterval04" class="me-3 mb-0">Time Interval</label>
      <select id="timeInterval04" class="form-select" style="width: auto;">
        <option value="day">This Day</option>
        <option value="week">This Week</option>
        <option value="month" selected>This Month</option>
        <option value="year">This Year</option>
        <option value="custom">Custom</option>
      </select>
      <a class="ms-2" href={% url 'report-view' result.cnf_charges.report.id %} target="_blank">View/Update<i class="fas fa-fw fa-external-link-alt"></i></a>
      <div class="mb-0 ms-0 ms-md-1 mt-2 mt-md-0" id="dateRangeContainer04" style="display: none;">
        <input type="text" id="datePicker04" class="form-control flatpickr-range" placeholder="Select date or date range" style="width: auto;" />
      </div>
    </div>

  </div>
  <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
    <table class="table table-striped table-bordered table-sm" id="cnf_concise">
        <tbody>
            <!-- Content will be populated by JavaScript -->
        </tbody>
    </table>
  </div>

</div>


<script>
  document.addEventListener("DOMContentLoaded", function() {
      var requestData = {};
      var currentDate = new Date();
      var lastYearDate = new Date();
      lastYearDate.setFullYear(currentDate.getFullYear() - 1);

      function formatDate(date) {
          var day = ("0" + date.getDate()).slice(-2);
          var month = ("0" + (date.getMonth() + 1)).slice(-2);
          var year = date.getFullYear();
          return year + '-' + month + '-' + day;
      }

      requestData = {
          start_date: formatDate(lastYearDate),
          end_date: formatDate(currentDate),
      };
  });
</script>


<script>
  const apiUrlCNF = '{% url "report-datefilter-data-api" result.cnf_charges.report.id|default:"0" %}';

  document.addEventListener("DOMContentLoaded", function() {  

    var choicesMultiple = document.querySelector(".choices-multiple");
    if (choicesMultiple) {
      new Choices(choicesMultiple);
    }
  
    // Flatpickr
    flatpickr(".flatpickr-minimum");
    flatpickr(".flatpickr-datetime", {
      enableTime: true,
      dateFormat: "d-m-Y H:i",
    });
    flatpickr(".flatpickr-human", {
      altInput: true,
      altFormat: "F j, Y",
      dateFormat: "d-m-Y",
    });
    flatpickr(".flatpickr-multiple", {
      mode: "multiple",
      dateFormat: "d-m-Y"
    });
    flatpickr(".flatpickr-range", {
      mode: "range",
      dateFormat: "d-m-Y",
      allowInput: true,
    });
    flatpickr(".flatpickr-time", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
    });
    
    // Date filter AJAX
    $(document).ready(function () {
      // Function to fetch and display data based on interval
      function fetchAndDisplayData(interval, startDate = null, endDate = null) {
        var requestData = {};

        if (interval === 'custom') {
          requestData = {
            start_date: startDate,
            end_date: endDate
          };
          $('#dateRangeContainer04').show(); // Show date range input when custom is selected
        } else {
          $('#dateRangeContainer04').hide();
          requestData = {
            interval: interval
          };
        }

        function populateTable(tableId, data) {
          const tableBody = document.querySelector(`#${tableId} tbody`);
          tableBody.innerHTML = data;
        }
        
        $.ajax({
          url: apiUrlCNF,
          type: 'GET',
          data: requestData,
          dataType: 'json',
          success: function(response) {
              if (response.data) {
                  populateTable("cnf_concise", response.data.cnf_concise || '<tr><td colspan="3" class="text-center">No data available</td></tr>');
              } else {
                  $('#cnf_concise tbody').html('<tr><td colspan="3" class="text-center">No data available</td></tr>');
              }
          },
          error: function(xhr, status, error) {
              $('#cnf_concise tbody').html('<tr><td colspan="3" class="text-center text-danger">Error fetching data</td></tr>');
          }
        });
      }

      function formatDate(dateString) {
        var parts = dateString.split('-');
        return parts[2] + '-' + parts[1] + '-' + parts[0];
      }

      function handleDateChange() {
        var dateRange = $('#datePicker04').val().split(' to ');
        if (dateRange.length === 2) {
          var startDate = formatDate(dateRange[0]);
          var endDate = formatDate(dateRange[1]);
          fetchAndDisplayData('custom', startDate, endDate);
        } else if (dateRange.length === 1) {
          var singleDate = formatDate(dateRange[0]);
          fetchAndDisplayData('custom', singleDate, singleDate);
        }
      }

      // Trigger fetching and displaying data when the page loads with the default selected interval
      fetchAndDisplayData($('#timeInterval04').val());

      // Event handler for when the select element's value changes
      $('#timeInterval04').change(function () {
        var selectedValue = $(this).val();
        if (selectedValue === 'custom') {
          $('#dateRangeContainer04').show();
          handleDateChange();
        } else {
          $('#dateRangeContainer04').hide();
          fetchAndDisplayData(selectedValue);
        }
      });

      // Event handler for date range change
      $('#datePicker04').change(function () {
        handleDateChange();
      });
    });
  });

</script>