{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <link href="{% static 'css/handsontable.full.min.css' %}" rel="stylesheet" />
    
    <!-- Choose your prefered color scheme -->
    <link href="{% static 'css/light.css' %}" rel="stylesheet" />
    {% comment %}
    <link href="{% static 'css/dark.css' %}" rel="stylesheet" />
    {% endcomment %}
    <link href="{% static 'css/styles.css' %}" rel="stylesheet" />
    <style>
        #spreadsheet {
          height: 400px;
          margin: 20px;
        }
        html, body {
            height: 100%; /* Ensure the full height is available */
            margin: 0; /* Remove default margin */
            padding: 0; /* Remove default padding */
        }
        #spreadsheet {
            height: calc(50vh - 40px); /* 100% of the viewport height minus some margin */
            width: 98%; /* Full width of the viewport */
            overflow: auto; /* Add scrollbars when content overflows */
            margin: 20px; /* Margin around the spreadsheet */
            border: solid;
            border-width: thin;
        }
    </style>
    
  </head>
  <body>
    <h2>Summary</h2>
    <div>Report name: {{ result.report }}</div>
    {% comment %}
    <div>Threshhold: {{ threshhold }}</div>
    <div>Total: {{ total}}</div>
    <div>Average: {{ average }}</div>
    <div style="color: red">Result: {{ result}}</div>
    {% endcomment %}

    <h2>Excel Data</h2>
    <hr />

    <button class="btn btn-primary" id="toggleButton">
      Show/Hide Excel Data
    </button>

    <button class="btn btn-primary" onclick="downloadExcel()">Download Excel</button>

    <div id="spreadsheet" class="handsontable" style="display: block"></div>

    <hr />
    <div class="table-responsive">{{ result.sales_analysis|safe }}</div>
    <div class="table-responsive">{{ result.branch_analysis|safe }}</div>
    <div class="table-responsive">{{ result.item_type_analysis|safe }}</div>
    <div class="table-responsive">
      {{ result.individual_by_item_type_analysis|safe }}
    </div>
    <div class="table-responsive">{{ result.branch_by_item_type_analysis|safe }}</div>

    <h2>Chart</h2>
    {% for i in result.myRange %}
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">Individual sale</h5>
          {% comment %}
          <h6 class="card-subtitle text-muted">
            A column chart uses vertical bars to display data and is used to
            compare values across {% endcomment %} categories.
          </h6>
        </div>
        <div class="card-body">
          <div class="chart w-100">
            <div id="apexcharts-column"></div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    
    <script>
        function cleanNumeric(value) {
            return parseFloat(value.replace(/[^0-9.-]+/g, ""));
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            // Parse the JSON data from the Django context
            var chartData = JSON.parse('{{ result.all_chart_data_json|safe }}');
        
            // Prepare data and labels
            var data = chartData.individual_chart_data.data.map(cleanNumeric);
            var labels = chartData.individual_chart_data.labels;
        
            // Combine the arrays: 'data' and 'labels'
            var combined = data.map(function(value, index) {
                return {
                    value: value,
                    label: labels[index]
                };
            });
        
            // Sort combined array by the 'value' in descending order
            combined.sort(function(a, b) {
                return b.value - a.value; // For descending sort
            });
        
            // Separate them back out
            var sortedData = combined.map(function(item) {
                return item.value;
            });
            var sortedLabels = combined.map(function(item) {
                return item.label;
            });
        
        
            // Column chart options
            var options = {
                chart: {
                    height: 350,
                    type: "bar",
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        endingShape: "rounded",
                        columnWidth: "55%",
                    },
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ["transparent"]
                },
                series: [{
                    name: "Net Total Sales",
                    data: sortedData // Ensure this data is numeric
                }],
                xaxis: {
                    categories: sortedLabels
                },
                yaxis: {
                    title: {
                        text: "Net Total (â‚¹)"
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    shared: true,
                    intersect: false, // Ensure this is set to false
                    y: {
                        formatter: function(val) {
                            return new Intl.NumberFormat('en-IN', {
                                maximumFractionDigits: 2,
                                style: 'currency',
                                currency: 'INR'
                            }).format(val);
                        }
                    }
                }
            };
        
            var chart = new ApexCharts(document.querySelector("#apexcharts-column"), options);
            chart.render();
        });
        
        
        
        document.getElementById('toggleButton').addEventListener('click', function() {
            var content = document.getElementById('spreadsheet');
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var jsonData = {{ result.report_excel_json|safe }};
            var data = Object.values(jsonData); // Convert object of objects into an array of objects

            var container = document.getElementById('spreadsheet');
            var hot = new Handsontable(container, {
                data: data,
                rowHeaders: true,
                colHeaders: [
                    "SR NO", "Invoice No", "Invoice Date", "Customer Name", "Customer GSTN", "Item Code",
                    "Item Name", "Quantity", "Rate", "Taxable Amt", "CGST", "SGST", "IGST", "Net Total",
                    "Sales Person", "Branch", "Item Type"
                ],
                columns: [
                    {data: 'SR NO', type: 'numeric'},
                    {data: 'Invoice No', type: 'text'},
                    {data: 'Invoice Date', type: 'date', dateFormat: 'MM/DD/YYYY'},
                    {data: 'Customer Name', type: 'text'},
                    {data: 'Customer GSTN', type: 'text'},
                    {data: 'Item Code', type: 'text'},
                    {data: 'Item Name', type: 'text'},
                    {data: 'Quantity', type: 'numeric'},
                    {data: 'Rate', type: 'numeric', numericFormat: {pattern: '$0,0.00'}},
                    {data: 'Taxable Amt', type: 'numeric', numericFormat: {pattern: '$0,0.00'}},
                    {data: 'CGST', type: 'numeric', numericFormat: {pattern: '$0,0.00'}},
                    {data: 'SGST', type: 'numeric', numericFormat: {pattern: '$0,0.00'}},
                    {data: 'IGST', type: 'numeric', numericFormat: {pattern: '$0,0.00'}},
                    {data: 'Net Total', type: 'numeric', numericFormat: {pattern: '$0,0.00'}},
                    {data: 'Sales Person', type: 'text'},
                    {data: 'Branch', type: 'text'},
                    {data: 'Item Type', type: 'text'}
                ],
                filters: true,
                dropdownMenu: true,
                manualColumnResize: true,
                manualRowResize: true,
                contextMenu: true,
                licenseKey: 'non-commercial-and-evaluation' // specify the license key here
            });
        });

        function downloadExcel() {
            // Retrieve and log the JSON data
            var jsonData = {{ result.report_excel_json|safe }};
        
            if (!Array.isArray(jsonData)) {
                console.error('Data is not an array:', jsonData);
                return; // Exit if data is not an array
            }
        
            // Continue with Excel file creation if data is correct
            const worksheet = XLSX.utils.json_to_sheet(jsonData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Report");
            XLSX.writeFile(workbook, "Report.xlsx");
        }
        
    </script>
    
    <script src="{% static 'js/handsontable.full.min.js' %}"></script>
    <script src="{% static 'js/xlsx.full.min.js' %}"></script>
    <script src="{% static 'js/app.js' %}"></script>
  </body>
</html>
