{% extends "commonutil/base.html" %}
{% load static %}

{% block title %} Report | {{ title }} {% endblock %}

{% block styles %}
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <link href="{% static 'css/handsontable.full.min.css' %}" rel="stylesheet" />
{% endblock styles %}

{% block content %}

    <h2>Summary</h2>
    <div>Report name: {{ report }}</div>
    {% comment %}
    <div>Threshhold: {{ threshhold }}</div>
    <div>Total: {{ total}}</div>
    <div>Average: {{ average }}</div>
    <div style="color: red">Result: {{ result}}</div>
    {% endcomment %}

    <h2>Excel Data</h2>
    <hr />

    <button class="btn btn-primary" id="toggleButton">
      Show/Hide Excel Data
    </button>

    <select id="timeInterval" class="form-select">
        <option value="day">This Day</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
        <option value="year">This Year</option>
        <option value="custom">Custom</option>
    </select>

    <button class="btn btn-primary" onclick="downloadExcel(window.reportExcelJson)">Download Excel</button>

    <div id="spreadsheet" class="handsontable" style="display: none"></div>

    <hr />
    <div class="table-responsive">{{ sales_analysis|safe }}</div>
    <div class="table-responsive">{{ branch_analysis|safe }}</div>
    <div class="table-responsive">{{ item_type_analysis|safe }}</div>
    <div class="table-responsive">
      {{ individual_by_item_type_analysis|safe }}
    </div>
    <div class="table-responsive">{{ branch_by_item_type_analysis|safe }}</div>

    <h2>Chart</h2>
    {% for i in myRange %}
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title">Individual sale</h5>
          {% comment %}
          <h6 class="card-subtitle text-muted">
            A column chart uses vertical bars to display data and is used to
            compare values across {% endcomment %} categories.
          </h6>
        </div>
        <div class="card-body">
          <div class="chart w-100">
            <div id="apexcharts-column"></div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    

    <script>
        window.reportExcelJson = {{ report_excel_json|safe }};  // Make JSON data available globally
        document.addEventListener("DOMContentLoaded", function () {
            new handsontableManager('spreadsheet');
        });
    </script>

    <script>
        function cleanNumeric(value) {
            return parseFloat(value.replace(/[^0-9.-]+/g, ""));
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            var chartData = JSON.parse('{{ all_chart_data_json|safe }}');
        
            var data = chartData.individual_chart_data.data.map(cleanNumeric);
            var labels = chartData.individual_chart_data.labels;
        
            var combined = data.map(function(value, index) {
                return {
                    value: value,
                    label: labels[index]
                };
            });
        
            combined.sort(function(a, b) {
                return b.value - a.value; // For descending sort
            });
        
            var sortedData = combined.map(function(item) {
                return item.value;
            });
            var sortedLabels = combined.map(function(item) {
                return item.label;
            });
        
            // Calculate average
            var totalSum = sortedData.reduce((sum, current) => sum + current, 0);
            var average = totalSum / sortedData.length;
        
            // ApexCharts options
            var options = {
                chart: {
                    height: 350,
                    type: 'bar',
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        endingShape: 'rounded',
                        columnWidth: '55%',
                    },
                },
                annotations: {
                    yaxis: [{
                        y: average,
                        borderColor: '#00E396',
                        label: {
                            borderColor: '#00E396',
                            style: {
                                color: '#fff',
                                background: '#00E396',
                            },
                            text: 'Average: ' + new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(average),
                        },
                    }]
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ["transparent"]
                },
                series: [{
                    name: 'Net Total Sales',
                    data: sortedData
                }],
                xaxis: {
                    categories: sortedLabels
                },
                yaxis: {
                    title: {
                        text: "Net Total (â‚¹)"
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    shared: true,
                    intersect: false, // Ensure this is set to false
                    y: {
                        formatter: function(val) {
                            var percentage = ((val - average) / average * 100).toFixed(2);
                            var sign = percentage >= 0 ? "+" : "";
                            return new Intl.NumberFormat('en-IN', {
                                maximumFractionDigits: 2,
                                style: 'currency',
                                currency: 'INR'
                            }).format(val) + ' (' + sign + percentage + '%)';
                        }
                    }
                },
            };
        
            var chart = new ApexCharts(document.querySelector("#apexcharts-column"), options);
            chart.render();
        });
        
        
        
        document.getElementById('toggleButton').addEventListener('click', function() {
            var content = document.getElementById('spreadsheet');
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        });
    </script>

    <script>
        $(document).ready(function() {
            $('#timeInterval').change(function() {
                var interval = $(this).val();
                fetchAndDisplayData(interval);
            });
    
            function fetchAndDisplayData(interval) {
                $.ajax({
                    url: '/api/report/1/',  // Adjust URL to your Django URL configuration
                    type: 'GET',
                    data: {
                        start_date: '2024-01-15',
                        end_date: '2024-02-15',
                        interval: interval  // make sure your API handles this parameter
                    },
                    dataType: 'json',
                    success: function(data) {
                        // Ensure that data is an array
                        if (typeof data === 'string') {
                            try {
                                data = JSON.parse(data);  // Parse string into JSON
                            } catch (e) {
                                console.error("Error parsing JSON!", e);
                            }
                        }
            
                        if (Array.isArray(data)) {
                            window.reportExcelJson = data;
                            new handsontableManager('spreadsheet');
                        } else {
                            console.error("Data is not an array:", data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX Error:", error);
                        $('#spreadsheet').html('<div class="alert alert-danger">Error fetching data.</div>');
                    }
                });
            }
            
        });
    </script>

    <script src="{% static 'js/handsontable.full.min.js' %}"></script>
    <script src="{% static 'js/xlsx.full.min.js' %}"></script>

{% endblock content %}