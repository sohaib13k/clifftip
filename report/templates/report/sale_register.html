{% extends 'commonutil/base.html' %}
{% load static %}

{% block title %}
  Report | {{ result.report.name }}
{% endblock %}

{% block styles %}
  <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
  <link href="{% static 'css/handsontable.full.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
  <div class="wrapper">
    {% include 'commonutil/sidebar.html' %}

    <div class="main">
      {% include 'commonutil/navbar.html' %}
      <div class="container mt-4 mb-4">
        <a href="{% url 'report-view' result.report.id %}?cached=false" class="btn btn-secondary">Reload without cache</a>
      </div>
      <div class="container my-5">
        <h2 class="mb-4">Summary</h2>
        <div>Report name: {{ result.report.name }}</div>
        {% comment %}
        <div>Threshhold: {{ threshhold }}</div>
        <div>Total: {{ total }}</div>
        <div>Average: {{ average }}</div>
        <div style="color: red">Result: {{ result }}</div>
        {% endcomment %}

        <h2 class="mt-5">Excel Data</h2>
        <div class="d-flex justify-content-between mb-2">
          <button class="btn btn-primary" id="toggleButton">Show/Hide Excel Data</button>

          {% include 'commonutil/time_interval_select.html' %}

          <button class="btn btn-primary" onclick="downloadExcel(window.reportExcelJson)">Download Excel</button>
        </div>
        <div id="spreadsheet" class="handsontable" style="display: block"></div>
      </div>
    </div>
  </div>
  <script>
    window.reportExcelJson
    document.addEventListener('DOMContentLoaded', function () {
      new handsontableManager('spreadsheet')
    })
  </script>

  {% comment %}date filter ajax{% endcomment %}
  <script>
    $(document).ready(function () {
      // Function to fetch and display data based on interval
      function fetchAndDisplayData(interval) {
        var requestData = {}
    
        if (interval == 'custom') {
          requestData = {
            start_date: '2024-01-15',
            end_date: '2024-02-15'
          }
        } else {
          requestData = {
            interval: interval
          }
        }
    
        $.ajax({
          url: '/api/report/{{ result.report.id }}/',
          type: 'GET',
          data: requestData,
          dataType: 'json',
          success: function (data) {
            if ($.isEmptyObject(data)) {
              $('#spreadsheet').html('<div class="alert alert-warning">No data available.</div>')
              return
            }
    
            if (typeof data === 'string') {
              data = JSON.parse(data)
            }
    
            if (Array.isArray(data)) {
              window.reportExcelJson = data
              new handsontableManager('spreadsheet')
            }
          },
          error: function (xhr, status, error) {
            $('#spreadsheet').html('<div class="alert alert-danger">Error fetching data.</div>')
          }
        })
      }
    
      // Trigger fetching and displaying data when the page loads with the default selected interval
      fetchAndDisplayData($('#timeInterval').val())
    
      // Event handler for when the select element's value changes
      $('#timeInterval').change(function () {
        fetchAndDisplayData($(this).val())
      })
    })
  </script>

  <script src="{% static 'js/handsontable.full.min.js' %}"></script>
  <script src="{% static 'js/xlsx.full.min.js' %}"></script>
{% endblock %}
