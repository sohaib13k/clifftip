{% extends "commonutil/base.html" %}
{% load static %}

{% block title %} Report | {{ result.report.name }} {% endblock %}

{% block styles %}
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <link href="{% static 'css/handsontable.full.min.css' %}" rel="stylesheet" />
{% endblock styles %}

{% block content %}

<div class="container my-5">
    <h2 class="mb-4">Summary</h2>
    <div>Report name: {{ result.report.name }}</div>

    <h2 class="mt-5">Excel Data</h2>
    <div class="d-flex justify-content-between mb-2">
        <button class="btn btn-primary" id="toggleButton">
            Show/Hide Excel Data
        </button>
        <button class="btn btn-primary" onclick="downloadExcel(window.reportExcelJson)">
            Download Excel
        </button>
    </div>

    {% include "commonutil/time_interval_select.html" %}
    
    {% comment %} <div id="spreadsheet" class="table-responsive">
        {{ result.table|safe }}
    </div> {% endcomment %}
</div>

<div id="spreadsheet" class="handsontable" style="display: block"></div>

<script>
    window.reportExcelJson = {{ result.data|safe }};
    document.addEventListener("DOMContentLoaded", function () {
        new handsontableManager('spreadsheet');
    });  
</script>

<script>
    document.getElementById('toggleButton').addEventListener('click', function() {
        var content = document.getElementById('spreadsheet');
        if (content.style.display === 'none') {
            content.style.display = 'block';
        } else {
            content.style.display = 'none';
        }
    });
</script>

{% comment %} date filter ajax {% endcomment %}
<script>
    $(document).ready(function() {
        $('#timeInterval').change(function() {
            var interval = $(this).val();
            fetchAndDisplayData(interval);
        });
    
        function fetchAndDisplayData(interval) {
            var requestData = {};  // Define an object to store request data
    
            // Conditionally set request data based on the interval
            if (interval == 'custom') {
                requestData = {
                    start_date: '2024-01-15',
                    end_date: '2024-02-15'
                };
            } else {
                requestData = {
                    interval: interval 
                };
            }
    
            $.ajax({
                url: '/api/report/{{ result.report.id }}/',  // Adjust URL to your Django URL configuration
                type: 'GET',
                data: requestData,  // Set the data based on the condition
                dataType: 'json',
                success: function(data) {
                    // Ensure that data is an array
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);  // Parse string into JSON
                        } catch (e) {
                            console.error("Error parsing JSON!", e);
                        }
                    }
    
                    if (Array.isArray(data)) {
                        window.reportExcelJson = data;
                        new handsontableManager('spreadsheet');
                    } else {
                        console.error("Data is not an array:", data);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", error);
                    $('#spreadsheet').html('<div class="alert alert-danger">Error fetching data.</div>');
                }
            });
        }
    }); 
</script>

<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/handsontable.full.min.js' %}"></script>
<script src="{% static 'js/xlsx.full.min.js' %}"></script>

{% endblock content %}